"use strict";var constants={layers:{arteries:"arteries",freeways:"freeways",neighborhoods:"neighborhoods",streets:"streets"},errors:{invalidURL:"Invalid url.."},ajax:{post:"post",get:"get",contentType:"application/json; charset=utf-8",header:{"Access-Control-Allow-Origin":"*"}},urls:{arteriesLazy:"/assets/arteries.json",freewaysLazy:"/assets/freeways.json",neighborhoodsLazy:"/assets/neighborhoods.json",streetsLazy:"/assets/streets.json",getNextBusAgencies:"http://webservices.nextbus.com/service/publicJSONFeed?command=agencyList",getNextBusAgencyRoutes:"http://webservices.nextbus.com/service/publicJSONFeed?command=routeList&a={0}",getNextBusRouteConfig:"http://webservices.nextbus.com/service/publicJSONFeed?command=routeConfig&a={0}&r={1}",getRouteVehicleLocations:"http://webservices.nextbus.com/service/publicJSONFeed?command=vehicleLocations&a={0}&r={1}&t={2}"},events:{drawRouteDirections:"draw-route-direction"},map:{width:900,height:1e3,d3:{scale:35e4,center:[-122.433701,37.767683],rotate:[0,0]},vehicleUpdateTimeSpan:15e3,defaultAgency:"sf-muni"}};$(document).ready(function(){svgUtility.init("div.map-place-holder"),new MapBuilder(new LazyLoadMapRepository).init(),new NextBusMapBuilder(new NextBusRepository).init()});var ajaxWrapper=function(){var t={},e={400:n,401:n,403:n,404:n,409:n,500:n,503:n,0:n,12031:n},n=function(){$(".alert").alert()},a=function(t){var n=$.Deferred();if(!t.url)throw new Error(constants.errors.invalidURL);return $.ajax({async:!0,url:t.url,type:t.type,cache:!1,data:t.data,statusCode:e,contentType:constants.ajax.contentType,error:function(t){n.reject(t,this.statusCode)},success:function(t){n.resolve(t)}}),n};return t.get=function(t){return a({url:t.url,type:constants.ajax.get,data:t.data})},t.post=function(t){return a({url:t.url,type:constants.ajax.post,data:t.data})},t.getCROS=function(t){return $.get(t.url)},t}(),AuditRepository=function(){this.AuditLog=function(t){}},MapRepository=function(){};MapRepository.prototype.getArteriesGeoJSON=function(){},MapRepository.prototype.getFreeWaysGeoJSON=function(){},MapRepository.prototype.getNeighborhoodsGeoJSON=function(){},MapRepository.prototype.getStreetsGeoJSON=function(){};var LazyLoadMapRepository=function(){MapRepository.call(this),this.getArteriesGeoJSON=function(){return ajaxWrapper.get({url:constants.urls.arteriesLazy,data:{}})},this.getFreeWaysGeoJSON=function(){return ajaxWrapper.get({url:constants.urls.freewaysLazy,data:{}})},this.getNeighborhoodsGeoJSON=function(){return ajaxWrapper.get({url:constants.urls.neighborhoodsLazy,data:{}})},this.getStreetsGeoJSON=function(){return ajaxWrapper.get({url:constants.urls.streetsLazy,data:{}})}},NextBusRepository=function(){this.getAgencies=function(){return ajaxWrapper.getCROS({url:constants.urls.getNextBusAgencies})},this.getRoutes=function(t){return ajaxWrapper.getCROS({url:constants.urls.getNextBusAgencyRoutes.replace("{0}",t)})},this.getRouteConfig=function(t,e){return ajaxWrapper.getCROS({url:constants.urls.getNextBusRouteConfig.replace("{0}",t).replace("{1}",e)})},this.getRouteVehicleLocations=function(t,e,n){return ajaxWrapper.getCROS({url:constants.urls.getRouteVehicleLocations.replace("{0}",t).replace("{1}",e).replace("{2}",n)})}},svgUtility=function(){var t,e,n,a,o={},r=function(){n.selectAll("g").attr("transform",d3.event.transform),n.selectAll("circle").attr("transform",d3.event.transform),n.selectAll("text").attr("transform",d3.event.transform)};return o.resetZoom=function(){a.transform(n.selectAll("g"),d3.zoomIdentity.scale(1)),a.transform(n.selectAll("circle"),d3.zoomIdentity.scale(1)),a.transform(n.selectAll("text"),d3.zoomIdentity.scale(1))},o.getColor=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},o.init=function(o){!function(t){a=d3.zoom().on("zoom",r),(n=d3.select(t).append("svg").attr("width",constants.map.width).attr("height",constants.map.height).call(a)).append("rect").attr("width",constants.map.width+50).attr("height",constants.map.height+50).style("fill","none").style("pointer-events","all")}(o),t=d3.geoMercator().scale(constants.map.d3.scale).rotate(constants.map.d3.rotate).center(constants.map.d3.center).translate([constants.map.width/2,constants.map.height/2]),e=d3.geoPath().projection(t)},o.addPath=function(t){n.append("g").attr("id",t.id).selectAll("path").data(t.data).enter().append("path").style("stroke",o.getColor()).attr("d",e)},o.addGroupLines=function(t){var e=n.append("g").attr("id",t.id||"").attr("class",t.class||"");_.each(t.lines,function(t){t=e.selectAll(".line_"+t.id).data(t.data).enter().append("line").attr("class","line_"+t.id).attr("stroke",o.getColor()).attr("stroke-width",t.stroke).attr("x1",function(t){return t[0][0]}).attr("y1",function(t){return t[0][1]}).attr("x2",function(t){return t[1][0]}).attr("y2",function(t){return t[1][1]})})},o.convertLogLatToXYPoints=function(e,n){return t([e,n])},o.drawCircle=function(t){n.append("circle").attr("cx",t.cx).attr("cy",t.cy).attr("r",t.radius).attr("id",t.id).attr("class",t.class).style("fill",t.color).text(t.text)},o.addText=function(t){n.append("text").attr("x",t.x).attr("y",t.y).attr("id",t.id).attr("font-family","sans-serif").attr("font-size","20px").attr("fill","white").attr("class",t.class).text(t.text)},o}(),MapLayer=function(t,e){this.name=t,this.repo=e},ArteriesLayer=function(t){MapLayer.call(this,constants.layers.arteries,t),this.getGeoJson=function(){return this.repo.getArteriesGeoJSON()}},FreewaysLayer=function(t){MapLayer.call(this,constants.layers.freeways,t),this.getGeoJson=function(){return this.repo.getFreeWaysGeoJSON()}},NeighborhoodsLayer=function(t){MapLayer.call(this,constants.layers.neighborhoods,t),this.getGeoJson=function(){return this.repo.getNeighborhoodsGeoJSON()}},StreetsLayer=function(t){MapLayer.call(this,constants.layers.streets,t),this.getGeoJson=function(){return this.repo.getStreetsGeoJSON()}},MapBuilder=function(t){var e=t,n=[new ArteriesLayer(e),new FreewaysLayer(e),new NeighborhoodsLayer(e),new StreetsLayer(e)],a=function(){_.each(n,function(t){t.getGeoJson().then(function(e){!function(t,e){svgUtility.addPath({id:t.name,data:e.features})}(t,e)})})};return{init:function(){a()}}};function NextBusMapBuilder(t){var e,n=t,a={},o=[],r=function(e){$(".route-list option").remove(),t.getRoutes(e).then(function(t){if(t.route.length)_.each(t.route,function(t){var e=document.createElement("option");e.text=t.title,e.value=t.tag,a.routeList.append(e)});else{var e=document.createElement("option");e.text=t.route.title,e.value=t.route.tag,a.routeList.append(e)}s(a.agencyList.val(),a.routeList.val())})},s=function(t,e){n.getRouteConfig(t,e).then(function(t){i(t),p(t),c(t.color)})},i=function(t){-1===_.indexOf(o,function(e){return e.name===t.route.tag})&&o.push({name:t.route.tag,color:"#"+t.route.color})},c=function(){_.each(o,function(t){n.getRouteVehicleLocations(a.agencyList.val(),a.routeList.val(),constants.map.vehicleUpdateTimeSpan).then(function(e){l(e,t),u()})})},u=function(){clearTimeout(e),e=setTimeout(c,constants.map.vehicleUpdateTimeSpan)},l=function(t,e){var n="vehicle-route-"+a.routeList.val(),o="vehicle-route-tab-"+a.routeList.val();$("."+n).remove(),$("."+o).remove(),svgUtility.resetZoom(),_.each(t.vehicle,function(t){var a=svgUtility.convertLogLatToXYPoints(t.lon,t.lat);svgUtility.drawCircle({cx:a[0],cy:a[1],radius:10,color:e.color,id:t.id,class:n}),svgUtility.addText({x:a[0],y:a[1],id:t.id,class:o,text:e.name})})},p=function(t){var e;e=d(t.route),svgUtility.addGroupLines({id:"route_"+t.route.tag,class:"route-layer",lines:e})},d=function(t){var e=[];return _.each(t.path,function(t,n){var a=[];_.each(t.point,function(e,n){n<t.point.length-1&&a.push([svgUtility.convertLogLatToXYPoints(t.point[n].lon,t.point[n].lat),svgUtility.convertLogLatToXYPoints(t.point[n+1].lon,t.point[n+1].lat)])}),e.push({data:a,id:"line_"+n,stroke:3})}),e};return{init:function(){a={agencyList:$(".agency-list"),routeList:$(".route-list")},t.getAgencies().then(function(t){_.each(t.agency,function(t){var e=document.createElement("option");e.text=t.title,e.value=t.tag,a.agencyList.append(e)}),a.agencyList.val(constants.map.defaultAgency),r(a.agencyList.val())}),a.agencyList.off("change").on("change",function(){r(this.value)}),a.routeList.off("change").on("change",function(){s(a.agencyList.val(),this.value)})}}}